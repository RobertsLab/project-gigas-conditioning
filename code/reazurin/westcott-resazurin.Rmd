---
title: Gill tissue resazurin trials
author: "AS Huffmyer"
date: '2025'
output:
  github_document: null
  md_document: default
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 6
    toc_float: true
editor_options: 
  chunk_output_type: console
---

# Set up 

Set up workspace, set options, and load required packages.    
```{r}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

Load libraries. 
```{r}
library(MASS) 
library(tidyverse)
library(ggplot2)
library(readxl)
library(cowplot)
library(lme4)
library(lmerTest)
library(car)
library(effects)
library(emmeans)
library(tools)
library(pracma)
```

# Fluorescence 

## Load data 

Read in 48 well data. 
```{r}
# Set the folder path
folder_path <- "data/resazurin/westcott/"  

# List all txt files in the folder
file_list <- list.files(path = folder_path, pattern = "\\.txt$", full.names = TRUE, recursive=TRUE)

# Check if any files are found
if (length(file_list) == 0) {
  stop("No txt files found in the specified folder. Check the folder path or file extension.")
}

# Initialize an empty list to store processed data
data_list <- list()

# Loop through each file and load the data
for (file in file_list) {
  # Ensure file is a character string
  if (!is.character(file)) next
  
  # Extract file name without extension
  file_name <- file_path_sans_ext(basename(file))
  
  # Read the text file, skipping the first row (metadata)
  data <- read.delim(file, header = FALSE, skip = 37)
  
  # Assign column names: first column is row labels (A–H), others are 1–12
  colnames(data) <- c("Row", as.character(1:9))
  
  #remove last column
  data<-data%>%select(-ncol(data))
  
  # Convert to long format
  data_long <- data %>%
    pivot_longer(cols = -Row, names_to = "Column", values_to = "Value") %>%
    mutate(
      Column = sprintf("%02d", as.integer(Column)),  # Ensure two-digit column numbers
      Well_ID = paste0(Row, Column),                # Format well ID as "A01", "B02", etc.
      FileName = file_name,                          # Add file name
      date = str_extract(file_name, "^\\d{8}"),     # Extract 8-digit date
      plate = str_extract(file_name, "plate\\d+"), #Extract plate ID 
      timepoint = str_extract(file_name, "T\\d+") %>% 
        str_remove("T") %>% 
        as.numeric()                                # Convert timepoint to numeric
    ) %>%
    select(FileName, plate, Well_ID, Value, date, timepoint)  # Select relevant columns
  
  # Store the processed data in the list
  data_list[[file_name]] <- data_long
}

# Print an example of processed data
head(data_list[[file_name]])


# Combine all data frames into a single data frame (optional)
combined_data <- bind_rows(data_list, .id = "Source")

# Print the first few rows of the combined data (optional)
head(combined_data)

# Rename columns
combined_data<-combined_data%>%
  rename("well"=Well_ID, resazurin_counts=`Value`)%>%
  mutate(timepoint=as.character(timepoint))

head(combined_data)
```

Load in metadata. 

```{r}
metadata<-read_xlsx(path="data/resazurin/westcott/westcott_resazurin_metadata.xlsx")%>%
  mutate(date=as.character(date))%>%
  mutate(tissue.mg=as.numeric(tissue.mg))

str(metadata)
```

Join with data frame and remove any wells that did not have samples. 

```{r}
full_data<-left_join(combined_data, metadata, by=c("date", "plate", "well"))%>%
  filter(!is.na(type))

head(full_data)

full_data<-full_data%>%
  mutate(temperature=factor(temperature))%>%
  mutate(individual=factor(individual))%>%
  mutate(temperature=factor(temperature))%>%
  mutate(experiment=factor(experiment))%>%
  mutate(treatment=factor(treatment))%>%
  mutate(group=factor(group))
```

## Prep the data 

Plot the raw data. 

```{r}
full_data%>%
  ggplot(aes(x=timepoint, y=resazurin_counts, colour=temperature, group=interaction(date, plate, well)))+
  facet_wrap(~group)+
  geom_point()+
  geom_line()+
  scale_colour_manual(values=c("darkblue", "darkred"))+
  theme_classic()
```

Calculate size normalized fluorescence at each time point normalized to the starting value at time 0. 
```{r}
full_data<-full_data%>%
  group_by(date, plate, well, individual, temperature)%>%
  arrange(date, plate, well)%>%
  mutate(fluorescence.norm=resazurin_counts/first(resazurin_counts))
```

Plot again. 

```{r}
full_data%>%
  ggplot(aes(x=timepoint, y=fluorescence.norm, colour=temperature, group=interaction(date, plate, well)))+
  facet_wrap(~group)+
  geom_point()+
  geom_line()+
  scale_colour_manual(values=c("darkblue", "darkred"))+
  theme_classic()
```

View blanks

```{r}
full_data%>%
  filter(type=="blank")%>%
  ggplot(aes(x=timepoint, y=fluorescence.norm, colour=temperature, group=interaction(date, plate, well)))+
  facet_wrap(~plate)+
  geom_point()+
  scale_colour_manual(values=c("darkblue", "darkred"))+
  geom_line()+
  theme_classic()
```

Calculate mean change in blank at each time point. Remove outlier blank.  

```{r}
blanks<-full_data%>%
  filter(type=="blank")%>%
  filter(fluorescence.norm<1.25)%>%
  group_by(date, plate, timepoint)%>%
  summarise(mean_blank=mean(fluorescence.norm));blanks
```

View summarized blank data. 

```{r}
blanks%>%
  ggplot(aes(x=timepoint, y=mean_blank))+
  facet_wrap(~plate)+
  geom_point()+
  theme_classic()
```

Subtract blank values from fluorescence values for oysters. 

```{r}
full_data<-left_join(full_data, blanks)

full_data<-full_data%>%
  filter(!type=="blank")%>%
  mutate(fluorescence.corr=fluorescence.norm-mean_blank)
```

Plot again. 

```{r}
full_data%>%
  ggplot(aes(x=timepoint, y=fluorescence.corr, colour=temperature, group=interaction(date, plate, well)))+
  facet_wrap(~group)+
  geom_point()+
  geom_line()+
  scale_colour_manual(values=c("darkblue", "darkred"))+
  theme_classic()
```

Size normalize data to tissue weight. 
```{r}
#normalize by weight
full_data<-full_data%>%
  mutate(fluorescence.corr.mg=fluorescence.corr/tissue.mg)
```

Plot again. 

```{r}
full_data%>%
  ggplot(aes(x=timepoint, y=fluorescence.corr.mg, colour=temperature, group=interaction(date, plate, well)))+
  facet_wrap(~group)+
  geom_point()+
  geom_line()+
  scale_colour_manual(values=c("darkblue", "darkred"))+
  theme_classic()
```

Remove unnecessary columns. 

```{r}
full_data<-full_data%>%
  rename(value=fluorescence.corr.mg)%>%
  filter(!type=="blank")%>%
  droplevels()
```

## Models and Plots    

### metabolic rate over time 

Plot data.  

```{r}
full_data%>%
  ggplot(aes(x=timepoint, y=value, colour=temperature, group=interaction(date, plate, well)))+
  facet_wrap(~group)+
  geom_point()+
  geom_line()+
  ylab("Fold change fluorescence per mg")+
  scale_colour_manual(values=c("darkblue", "darkred"))+
  theme_classic()
```

Plot by group. 
```{r}
plot1<-full_data%>%
  ggplot(aes(x=timepoint, y=value, colour=temperature, group=interaction(date, plate, well), fill=temperature))+
  facet_grid(~group)+
  geom_point(alpha=0.3)+
  scale_colour_manual(values=c("darkblue", "darkred"), name="")+
  scale_fill_manual(values=c("darkblue", "darkred"), name="")+
  geom_line()+
  ylab(expression(paste("Fold Change in Fluorescence (mm" ^-1, ")")))+
  xlab("Hours")+
  theme_classic();plot1

ggsave(plot1, filename="figures/resazurin/westcott_group_trajectories.png", width=12, height=5, units="in")
```

```{r}
plot1a<-full_data%>%
  ggplot(aes(x=timepoint, y=value, colour=temperature, group=interaction(date, plate, well), fill=temperature))+
  facet_grid(~group)+
  geom_smooth(aes(group=temperature), method="lm")+
  scale_colour_manual(values=c("darkblue", "darkred"), name="")+
  scale_fill_manual(values=c("darkblue", "darkred"), name="")+
  ylab(expression(paste("Fold Change in Fluorescence (mm" ^-1, ")")))+
  xlab("Hours")+
  theme_classic();plot1a

ggsave(plot1a, filename="figures/resazurin/westcott_mean_trajectories2.png", width=12, height=5, units="in")
```

Plot by temperature. 
```{r}
plot2<-full_data%>%
  ggplot(aes(x=timepoint, y=value, colour=treatment, group=interaction(date, plate, well), fill=treatment))+
  facet_grid(~experiment*temperature)+
  geom_point(alpha=0.3)+
  scale_colour_manual(values=c("darkgray", "orange"), name="")+
  scale_fill_manual(values=c("darkgray", "orange"), name="")+
  geom_line()+
  ylab(expression(paste("Fold Change in Fluorescence (mm" ^-1, ")")))+
  xlab("Hours")+
  theme_classic();plot2

ggsave(plot2, filename="figures/resazurin/westcott_group_trajectories2.png", width=12, height=5, units="in")
```

Plot mean responses. 

```{r}
plot3<-full_data%>%
  ggplot(aes(x=timepoint, y=value, colour=treatment, group=interaction(date, plate, well), fill=treatment))+
  facet_grid(~experiment*temperature)+
  #geom_point(alpha=0.3)+
  geom_smooth(aes(group=group), method="lm")+
  scale_colour_manual(values=c("darkgray", "orange"), name="")+
  scale_fill_manual(values=c("darkgray", "orange"), name="")+
  #geom_line()+
  ylab(expression(paste("Fold Change in Fluorescence (mm" ^-1, ")")))+
  xlab("Hours")+
  theme_classic();plot3

ggsave(plot3, filename="figures/resazurin/westcott_mean_trajectories.png", width=12, height=5, units="in")
```

Model trajectories. 

Daily
```{r}
model<-full_data%>%
  filter(experiment=="Daily")%>%
  lmer((value)^(1/3) ~ treatment * temperature * timepoint + (1|individual:plate), data=.)

anova(model)
qqPlot(residuals(model))

emm<-emmeans(model, ~treatment|timepoint)
pairs(emm)

emm<-emmeans(model, ~temperature|timepoint)
pairs(emm)
```

There is a difference in metabolic rates between control and treated regardless of temperature. There are differences by treatment regardless of hardening effects.  

Weekly
```{r}
model<-full_data%>%
  filter(experiment=="Weekly")%>%
  lmer((value)^(1/3) ~ treatment * temperature * timepoint + (1|individual:plate), data=.)

anova(model)
qqPlot(residuals(model))

emm<-emmeans(model, ~treatment|timepoint)
pairs(emm)

emm<-emmeans(model, ~temperature|timepoint)
pairs(emm)
```

There are temperature effects, but no hardening treatment effects. 

### AUC 

Calculate AUC for each individual 
```{r}
auc<-full_data%>%
  select(date, plate, well, individual, temperature, timepoint, group, experiment, treatment, value)%>%
  
  mutate(time=as.numeric(timepoint))%>%
  group_by(date, plate, well, individual, group, experiment, treatment, temperature) %>%
  dplyr::summarise(AUC = trapz(time, value));auc
  
```

```{r}
auc%>%
  ggplot(aes(x=temperature, y=AUC, colour=temperature))+
  facet_wrap(~group)+
  geom_boxplot()+
  geom_point()+
  geom_line()+
  ylab("AUC")+
  scale_colour_manual(values=c("darkblue", "darkred"))+
  theme_classic()
```

```{r}
plot4<-auc%>%
  group_by(group, experiment, treatment, temperature)%>%
  summarise(mean=mean(AUC, na.rm=TRUE), se=sd(AUC, na.rm=TRUE)/sqrt(length(AUC)))%>%
  
  ggplot(aes(x=temperature, y=mean, colour=treatment))+
  facet_wrap(~experiment, scales="free_x")+
  geom_point(size=4, position=position_dodge(0.2))+
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=0, position=position_dodge(0.2))+
  ylab("AUC")+
  geom_line(aes(group=treatment), position=position_dodge(0.2))+
  scale_colour_manual(values=c("darkgray", "orange"), name="")+
  theme_classic()+
  xlab("Temperature");plot4

ggsave(plot4, filename="figures/resazurin/westcott_mean_AUC.png", width=10, height=5, units="in")
```

```{r}
plot5<-auc%>%
  group_by(group, experiment, treatment, temperature)%>%
  summarise(mean=mean(AUC, na.rm=TRUE), se=sd(AUC, na.rm=TRUE)/sqrt(length(AUC)))%>%
  
  ggplot(aes(x=temperature, y=mean, colour=experiment))+
  facet_wrap(~treatment, scales="free_x")+
  geom_point(size=4, position=position_dodge(0.2))+
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=0, position=position_dodge(0.2))+
  ylab("AUC")+
  geom_line(aes(group=experiment), position=position_dodge(0.2))+
  scale_colour_manual(values=c("darkgreen", "purple"), name="")+
  theme_classic()+
  xlab("Temperature");plot5

#ggsave(plot4, filename="figures/resazurin/westcott_mean_AUC.png", width=10, height=5, units="in")
```

Model 

Daily 
```{r}
model<-auc%>%
  filter(experiment=="Daily")%>%
  aov((AUC)^(1/3) ~ treatment * temperature, data=.)

anova(model)
qqPlot(residuals(model))

emm<-emmeans(model, ~treatment|temperature)
pairs(emm)

emm<-emmeans(model, ~temperature)
pairs(emm)
```

Total metabolic activity is higher in treated oysters at both temperatures. 

Metabolic rates are higher at high temperature.  

Weekly 
```{r}
model<-auc%>%
  filter(experiment=="Weekly")%>%
  aov((AUC)^(1/3) ~ treatment * temperature, data=.)

anova(model)
qqPlot(residuals(model))

emm<-emmeans(model, ~treatment|temperature)
pairs(emm)

emm<-emmeans(model, ~temperature)
pairs(emm)
```

Total metabolic activity is lower at elevated temperature. 

Metabolic rates are higher at high temperature.  

Compare efforts 
```{r}
model<-auc%>%
  aov((AUC)^(1/3) ~ group * temperature, data=.)

anova(model)
qqPlot(residuals(model))

emm<-emmeans(model, ~group|temperature)
pairs(emm)

emm<-emmeans(model, ~temperature)
pairs(emm)
```

## Individual temperature differential response 

Calculate difference in AUC between samples of the same individual between temperatures. 

```{r}
head(auc)

auc_ind<-auc%>%
  ungroup()%>%
  select(!c(date, plate, well))%>%
  pivot_wider(names_from="temperature", values_from=("AUC"))%>%
  
  mutate(perc_diff=((`33`-`22`)/`33`)*100)

head(auc_ind)
```

```{r}
auc_ind%>%
  group_by(experiment, treatment)%>%
  summarise(mean=mean(perc_diff, na.rm=TRUE), se=sd(perc_diff, na.rm=TRUE)/sqrt(length(perc_diff)))%>%
  
  ggplot(aes(x=treatment, y=mean, colour=treatment, group=treatment))+
  facet_wrap(~experiment)+
  geom_point(size=4)+
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=0)+
  ylab("Percent change in AUC [high-control]")+
  scale_colour_manual(values=c("darkgray", "orange"))+
  theme_classic()
```

Run a model 

Daily 
```{r}
model<-auc_ind%>%
  filter(experiment=="Daily")%>%
  aov((perc_diff)^(1/3) ~ treatment, data=.)

anova(model)
qqPlot(residuals(model))
```

No effect

Weekly 
```{r}
model<-auc_ind%>%
  filter(experiment=="Weekly")%>%
  aov((perc_diff)^(1/3) ~ treatment, data=.)

anova(model)
qqPlot(residuals(model))
```

No effect


